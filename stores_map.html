<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <title>Carte des magasins — Import CSV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+e2kG6k8fQbZ8XCMbfoXK3p0i0sH0Y+v1h2yZ0wYQ=" crossorigin=""/>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 0; }
    #map { height: 80vh; }
    #controls { padding: 10px; background: #f4f4f4; }
    .note-area { width: 100%; height: 80px; }
    .marker-row { margin-bottom:8px; }
  </style>
</head>
<body>
  <div id="controls">
    <strong>Importer un fichier CSV</strong> — colonnes requises: <code>id,name,address,lat,lon,phone,contact</code>.<br>
    Exemple: <code>1;Magasin A;10 rue X, Paris;48.8566;2.3522;+33123456789;Paul Dupont</code><br>
    <input type="file" id="fileInput" accept=".csv,.txt" />
    <button id="loadSample">Charger exemple</button>
    <span id="status"></span>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-QVb0rYhJgqT6s8j0p2Y1sB8s4Q0K1r2oJ7r9gW2x0jk=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const map = L.map('map').setView([46.8, 2.6], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const markersLayer = L.layerGroup().addTo(map);

    function clearMarkers(){ markersLayer.clearLayers(); }

    function addMarker(item){
      const lat = parseFloat(item.lat);
      const lon = parseFloat(item.lon);
      if(isNaN(lat) || isNaN(lon)) return;
      const id = item.id || (item.name + '|' + item.lat + ',' + item.lon);
      const popupContent = document.createElement('div');

      const title = document.createElement('div');
      title.innerHTML = '<strong>' + (item.name || 'Sans nom') + '</strong>';
      popupContent.appendChild(title);

      const info = document.createElement('div');
      info.innerHTML = '<em>' + (item.address || '') + '</em><br>☎ ' + (item.phone || '') + '<br>Contact: ' + (item.contact || '');
      popupContent.appendChild(info);

      const noteLabel = document.createElement('div');
      noteLabel.style.marginTop = '8px';
      noteLabel.textContent = 'Notes (sauvegardées localement):';
      popupContent.appendChild(noteLabel);

      const textarea = document.createElement('textarea');
      textarea.className = 'note-area';
      const storageKey = 'store_notes_' + id;
      textarea.value = localStorage.getItem(storageKey) || '';
      popupContent.appendChild(textarea);

      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Enregistrer note avec date';
      saveBtn.style.display = 'block';
      saveBtn.style.marginTop = '6px';
      saveBtn.onclick = function(){
        const now = new Date().toLocaleString('fr-FR');
        const existing = localStorage.getItem(storageKey) || '';
        const newText = existing + '\\n--- ' + now + ' ---\\n' + textarea.value;
        localStorage.setItem(storageKey, newText);
        alert('Note sauvegardée localement.');
      };
      popupContent.appendChild(saveBtn);

      const viewHistory = document.createElement('button');
      viewHistory.textContent = 'Voir historique des notes';
      viewHistory.style.display = 'inline-block';
      viewHistory.style.marginLeft = '8px';
      viewHistory.onclick = function(){
        alert(localStorage.getItem(storageKey) || 'Aucune note enregistrée.');
      };
      popupContent.appendChild(viewHistory);

      const marker = L.marker([lat,lon]).bindPopup(popupContent);
      markersLayer.addLayer(marker);
    }

    function handleData(data){
      clearMarkers();
      if(!data || data.length === 0){ document.getElementById('status').textContent = 'Aucun enregistrement trouvé.'; return; }
      data.forEach(row => addMarker(row));
      // Adjust map to markers
      const bounds = markersLayer.getBounds();
      if(bounds.isValid()) map.fitBounds(bounds.pad(0.2));
      document.getElementById('status').textContent = data.length + ' points affichés.';
    }

    document.getElementById('fileInput').addEventListener('change', function(e){
      const f = e.target.files[0];
      if(!f) return;
      Papa.parse(f, {
        header: true,
        delimiter: /[;,\\t]/,
        skipEmptyLines: true,
        complete: function(res){ handleData(res.data); }
      });
    });

    document.getElementById('loadSample').addEventListener('click', function(){
      const sample = [
        {id:'1', name:'Magasin A', address:'10 Rue de la Paix, Paris', lat:'48.8566', lon:'2.3522', phone:'+33123456789', contact:'Paul Dupont'},
        {id:'2', name:'Magasin B', address:'20 Av. de la République, Lyon', lat:'45.7640', lon:'4.8357', phone:'+33498765432', contact:'Marie Leroy'}
      ];
      handleData(sample);
    });

    // If user pastes CSV text, parse it
    window.addEventListener('paste', function(e){
      const text = (e.clipboardData || window.clipboardData).getData('text');
      if(!text) return;
      Papa.parse(text, {
        header: true,
        delimiter: /[;,\\t]/,
        skipEmptyLines: true,
        complete: function(res){ handleData(res.data); }
      });
    });
  </script>
</body>
</html>
